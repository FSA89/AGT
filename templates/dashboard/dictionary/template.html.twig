{% extends 'dashboard/layout.html.twig' %}

{% block title %}–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫: –®–∞–±–ª–æ–Ω—ã (Templates){% endblock %}

{% block body %}
<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üé® –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫: –®–∞–±–ª–æ–Ω—ã (Templates)</h2>
        <div>
            <button id="add-row" class="btn btn-info text-white me-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button id="save-table" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="status-msg" class="alert d-none"></div>
    <div id="template-table"></div>
</div>
{% endblock %}

{% block javascripts %}
<style>
    /* 1. –°—Ç–∏–ª—å –¥–ª—è –†–ï–ñ–ò–ú–ê –ü–†–û–°–ú–û–¢–†–ê (–°–≤–µ—Ä–Ω—É—Ç—ã–π) */
    .compact-view {
        max-height: 40px;       /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É ~2 —Å—Ç—Ä–æ–∫–∏ */
        overflow: hidden;       /* –û–±—Ä–µ–∑–∞–µ–º –ª–∏—à–Ω–µ–µ */
        text-overflow: ellipsis;
        white-space: nowrap;    /* –¢–µ–∫—Å—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É (–º–æ–∂–Ω–æ pre-wrap, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ 2 —Å—Ç—Ä–æ–∫–∏) */
        font-family: monospace; /* –ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∫–æ–¥–∞ */
        color: #555;
        font-size: 12px;
        cursor: pointer;        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å */
        padding-top: 4px;
    }
    
    /* –î–æ–±–∞–≤–∏–º –∏–∫–æ–Ω–∫—É "–≥–ª–∞–∑", —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ —Ç–∞–º —Å–∫—Ä—ã—Ç—ã–π –∫–æ–¥ */
    .compact-view::before {
        content: "\f1c9"; /* –ö–æ–¥ –∏–∫–æ–Ω–∫–∏ File Code –∏–∑ FontAwesome */
        font-family: "Font Awesome 6 Free"; 
        font-weight: 900;
        margin-right: 5px;
        color: #0d6efd;
    }

    /* 2. –°—Ç–∏–ª—å –¥–ª—è –†–ï–ñ–ò–ú–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π) */
    /* –ö–æ–≥–¥–∞ –∫–ª–∏–∫–∞–µ—à—å, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è textarea. –î–µ–ª–∞–µ–º –µ—ë –±–æ–ª—å—à–æ–π. */
    .tabulator-cell textarea {
        min-height: 400px !important; /* –ë–æ–ª—å—à–∞—è –≤—ã—Å–æ—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ */
        font-family: monospace;
        font-size: 13px;
        line-height: 1.4;
        background-color: #fff !important;
        border: 2px solid #0d6efd !important;
        padding: 10px;
        z-index: 1000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const tableData = {{ table_json|raw }};

    // –§–æ—Ä–º–∞—Ç—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä—è—á–µ—Ç –±–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç –≤ –º–∞–ª–µ–Ω—å–∫–∏–π div
    const compactFormatter = function(cell) {
        let val = cell.getValue();
        if(!val) return "";
        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Ç–µ–≥–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–∏ –≤–µ—Ä—Å—Ç–∫—É
        let text = val.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return `<div class="compact-view" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">${text}</div>`;
    };

    var table = new Tabulator("#template-table", {
        data: tableData,
        layout: "fitDataFill",
        height: "80vh",
        movableColumns: true,

         // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫
        rowFormatter: function(row) {
            if(!row.getData().id) {
                row.getElement().classList.add("row-new");
            }
        },
        
        columns: [
            {title:"ID", field:"id", width:100, frozen:true},
            
            // –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
            {title:"–ù–∞–∑–≤–∞–Ω–∏–µ (Name)", field:"template_name", editor:"input", width:200, frozen:true},
            
            // –°–µ—Ä–≤–µ—Ä
            {title:"–°–µ—Ä–≤–µ—Ä (Server)", field:"server_name", editor:"input", width:120},

            // –ö–Ω–æ–ø–∫–∞ (URL —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞)
            {title:"URL –ö–Ω–æ–ø–∫–∏ (Button)", field:"button_url", editor:"input", width:200},

            // JSON –ö–æ–Ω—Ñ–∏–≥ (–°–∂–∏–º–∞—é—â–∏–π—Å—è)
            {
                title:"JSON –ö–æ–Ω—Ñ–∏–≥ (Structure)", 
                field:"json_template", 
                width: 500, // –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏
                
                formatter: compactFormatter, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à —Å–∂–∏–º–∞—Ç–µ–ª—å
                
                editor: "textarea", // –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–æ–ª—å—à–∞—è textarea
                headerSort: false
            },

            // –í–∫–ª/–í—ã–∫–ª
            {
                title:"–í–∫–ª", 
                field:"is_active", 
                editor:true, 
                formatter:"tickCross", 
                hozAlign:"center", 
                width:100,
                editorParams:{
                    tristate:false,
                    indeterminateValue:null
                }
            },

            // –£–¥–∞–ª–µ–Ω–∏–µ
            {title:"–£–¥–∞–ª–∏—Ç—å", formatter:"buttonCross", width:100, align:"center", headerSort:false, cellClick:function(e, cell){
                if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?")) {
                    let id = cell.getRow().getData().id;
                    if(id) {
                         fetch('{{ path('api_template_delete') }}', {
                            method: 'POST',
                            body: JSON.stringify({id: id})
                        })
                        .then(res => res.json())
                        .then(res => {
                            if(res.status === 'success') {
                                cell.getRow().delete();
                            } else {
                                alert("–û—à–∏–±–∫–∞: " + (res.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å"));
                            }
                        });
                    } else {
                        cell.getRow().delete();
                    }
                }
            }}
        ],
    });

    // –ö–Ω–æ–ø–∫–∏
    document.getElementById("add-row").addEventListener("click", function(){

        const newRowData = {
            template_name: "New Template",
            json_template: "[\n  {\"type\": \"logo\", \"position\": \"header-1\"}\n]",
            is_active: true
        };

         table.addRow(newRowData).then(function(row){
            // 1. –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª
            table.scrollToRow(row, "top", true);
            
            // 2. –§–æ–∫—É—Å –≤ –ø–µ—Ä–≤—É—é —è—á–µ–π–∫—É 
            row.getCells()[1].edit(); 
        });
    });

    document.getElementById("save-table").addEventListener("click", function(){
        const btn = this;
        const msg = document.getElementById("status-msg");
        btn.disabled = true;
        btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

        fetch('{{ path('api_template_save') }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(table.getData())
        })
        .then(res => res.json())
        .then(res => {
            msg.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-danger';
            msg.innerText = res.message;
            msg.classList.remove('d-none');
            setTimeout(() => msg.classList.add('d-none'), 3000);
            
            if(res.status === 'success') {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            console.error(err);
            msg.className = 'alert alert-danger';
            msg.innerText = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            msg.classList.remove('d-none');
        })
        .finally(() => btn.disabled = false);
    });
});
</script>
{% endblock %}