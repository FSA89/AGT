{% extends 'dashboard/layout.html.twig' %}

{% block title %}–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫: –°—Ö–µ–º—ã –ù–µ–π—Ä–æ (Scheme){% endblock %}

{% block body %}
<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üîó –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫: –°—Ö–µ–º—ã –ù–µ–π—Ä–æ (Schemes)</h2>
        <div>
            <button id="add-row" class="btn btn-info text-white me-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button id="save-table" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="status-msg" class="alert d-none"></div>
    <div id="scheme-table"></div>
</div>
{% endblock %}

{% block javascripts %}
<style>
    /* –¢–µ–≥–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ (—Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞) */
    .neuro-tag {
        display: inline-block;
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 6px;
        margin: 1px;
        border-radius: 4px;
        font-size: 0.85em;
        border: 1px solid #ced4da;
    }
    .neuro-tag i {
        font-size: 0.8em;
        margin-right: 3px;
        color: #0d6efd;
    }
    
    /* –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –∞–≤—Ç–æ, —Å–¥–µ–ª–∞–µ–º —á—É—Ç—å –±–ª–µ–¥–Ω–µ–µ (ReadOnly) */
    .tabulator-cell[tabulator-field="scheme_neuro"],
    .tabulator-cell[tabulator-field="scheme_neuro_full"] {
        background-color: #f8f9fa;
        color: #666;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    if (typeof Tabulator === 'undefined') {
        alert('–û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Tabulator –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ layout.html.twig –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
        return;
    }

    const tableData = {{ table_json|raw }};
    const rawNeuro  = {{ dict_neuro|raw }}; 

    // --- 1. –°–ü–ò–°–ö–ò ---
    function createOptions(dict) {
        let opts = Object.keys(dict).map(key => ({
            label: dict[key], 
            value: parseInt(key)
        }));
        opts.unshift({label: "--- –ù–µ –≤—ã–±—Ä–∞–Ω–æ ---", value: null});
        return opts;
    }
    const optionsSingle = createOptions(rawNeuro);

    // --- 2. –§–û–†–ú–ê–¢–¢–ï–†–´ ---
    
    // –†–∏—Å—É–µ—Ç —Ç–µ–≥–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏ "1+2"
    const chainFormatter = function(cell) {
        let val = cell.getValue();
        if (!val) return "";
        // –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É "1+5" –ø–æ –ø–ª—é—Å—É
        let ids = val.toString().split('+');
        let html = "";
        ids.forEach(id => {
            let numericId = parseInt(id);
            let name = rawNeuro[numericId];
            if(name) { 
                html += `<span class="neuro-tag"><i class="fas fa-robot"></i>${name}</span>`;
            }
        });
        return html;
    };

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–º—è –≤–º–µ—Å—Ç–æ ID
    const lookupFormatter = function(cell) {
        let val = cell.getValue();
        if(!val) return "";
        return rawNeuro[val] || val;
    };

    // --- 3. –õ–û–ì–ò–ö–ê –ü–ï–†–ï–°–ß–ï–¢–ê (–ê–í–¢–û–ó–ê–ü–û–õ–ù–ï–ù–ò–ï) ---
    function recalculateSchemes(row) {
        const data = row.getData();
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Å–æ–±–∏—Ä–∞–µ—Ç –º–∞—Å—Å–∏–≤ ID –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–ª–µ–π
        const collectIds = (fields) => {
            let ids = [];
            fields.forEach(field => {
                let val = data[field];
                if (val && val > 0) { // –ï—Å–ª–∏ ID –≤—ã–±—Ä–∞–Ω
                    ids.push(val);
                }
            });
            return ids.join('+'); // –°–∫–ª–µ–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ –ø–ª—é—Å
        };

        // 1. –ö–æ—Ä–æ—Ç–∫–∞—è —Å—Ö–µ–º–∞ (–ù–∞–∑–≤–∞–Ω–∏–µ): Writer + Text Corrector
        const shortScheme = collectIds(['writer_id', 'text_corrector_id']);
        
        // 2. –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ (Logic): –í—Å–µ 5 –ø–æ–ª–µ–π –ø–æ –ø–æ—Ä—è–¥–∫—É
        const fullScheme = collectIds([
            'structure_analyzer_id', 
            'meta_header_generator_id', 
            'writer_id', 
            'meta_corrector_id', 
            'text_corrector_id'
        ]);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏, –≤–∏–∑—É–∞–ª—å–Ω–æ)
        row.update({
            scheme_neuro: shortScheme,
            scheme_neuro_full: fullScheme
        });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤ —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –ø–µ—Ä–µ—Å—á–µ—Ç–∞
    const editorParamsSingle = {
        values: optionsSingle,
        autocomplete: true,     
        listOnEmpty: true,
        clearable: true
    };

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    const onCellEdited = function(cell) {
        recalculateSchemes(cell.getRow());
    };


    // --- 4. –¢–ê–ë–õ–ò–¶–ê ---
    var table = new Tabulator("#scheme-table", {
        data: tableData,
        layout: "fitDataFill",
        height: "80vh",
        movableColumns: true,

         // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫
        rowFormatter: function(row) {
            if(!row.getData().id) {
                row.getElement().classList.add("row-new");
            }
        },
        
        columns: [
            {title:"ID", field:"id", width:50, frozen:true},
            
            // --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –ü–û–õ–Ø (READ ONLY) ---
            {
                title:"–¶–µ–ø–æ—á–∫–∞ (Writer + Corrector)", 
                field:"scheme_neuro", 
                width:300, 
                frozen:true,
                formatter: chainFormatter, // –¢–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä, –ë–ï–ó —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            },
            {
                title:"–ü–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ (All 5)", 
                field:"scheme_neuro_full", 
                width:400,
                formatter: chainFormatter, // –¢–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
            },

            // --- –†–ï–î–ê–ö–¢–ò–†–£–ï–ú–´–ï –ü–û–õ–Ø ---
            { 
                title:"Structure Analyzer", field:"structure_analyzer_id", width:200, 
                formatter: lookupFormatter, editor:"list", editorParams: editorParamsSingle,
                cellEdited: onCellEdited 
            },
            { 
                title:"Header Generator", field:"meta_header_generator_id", width:200, 
                formatter: lookupFormatter, editor:"list", editorParams: editorParamsSingle,
                cellEdited: onCellEdited 
            },
            { 
                title:"Writer (–ü–∏—Å–∞—Ç–µ–ª—å)", field:"writer_id", width:200, 
                formatter: lookupFormatter, editor:"list", editorParams: editorParamsSingle,
                cellEdited: onCellEdited 
            },
            { 
                title:"Meta Corrector", field:"meta_corrector_id", width:200, 
                formatter: lookupFormatter, editor:"list", editorParams: editorParamsSingle,
                cellEdited: onCellEdited 
            },
            { 
                title:"Text Corrector", field:"text_corrector_id", width:200, 
                formatter: lookupFormatter, editor:"list", editorParams: editorParamsSingle,
                cellEdited: onCellEdited 
            },

            // –í–∫–ª/–í—ã–∫–ª
            {
                title:"–í–∫–ª", 
                field:"is_active", 
                editor:true, 
                formatter:"tickCross", 
                hozAlign:"center", 
                width:100,
                editorParams:{
                    tristate:false,
                    indeterminateValue:null
                }
            },

            // –£–¥–∞–ª–µ–Ω–∏–µ
            {title:"–£–¥–∞–ª–∏—Ç—å", formatter:"buttonCross", width:100, align:"center", headerSort:false, cellClick:function(e, cell){
                if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ö–µ–º—É?")) {
                    let id = cell.getRow().getData().id;
                    if(id) {
                         fetch('{{ path('api_scheme_delete') }}', {
                            method: 'POST',
                            body: JSON.stringify({id: id})
                        }).then(() => cell.getRow().delete());
                    } else {
                        cell.getRow().delete();
                    }
                }
            }}
        ],
    });

    // --- 5. –ö–ù–û–ü–ö–ò ---
    document.getElementById("add-row").addEventListener("click", function(){

         const newRowData = {
             scheme_neuro: "",       
            scheme_neuro_full: "",  
            structure_analyzer_id: null,
            meta_header_generator_id: null,
            writer_id: null,
            meta_corrector_id: null,
            text_corrector_id: null,
            is_active: true
        };

         table.addRow(newRowData).then(function(row){
            // 1. –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª
            table.scrollToRow(row, "top", true);
            
            // 2. –§–æ–∫—É—Å –≤ –ø–µ—Ä–≤—É—é —è—á–µ–π–∫—É 
            row.getCells()[1].edit(); 
        });
    });

    document.getElementById("save-table").addEventListener("click", function(){
        const btn = this;
        const msg = document.getElementById("status-msg");
        btn.disabled = true;
        btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

        fetch('{{ path('api_scheme_save') }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(table.getData())
        })
        .then(res => res.json())
        .then(res => {
            msg.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-danger';
            msg.innerText = res.message;
            msg.classList.remove('d-none');
            setTimeout(() => msg.classList.add('d-none'), 3000);
            
            if(res.status === 'success') {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            console.error(err);
            msg.className = 'alert alert-danger';
            msg.innerText = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            msg.classList.remove('d-none');
        })
        .finally(() => btn.disabled = false);
    });
});
</script>
{% endblock %}