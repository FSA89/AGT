{% extends 'dashboard/layout.html.twig' %}

{% block title %}Ð¡Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº: Hreflang{% endblock %}

{% block body %}
<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>ðŸ“š Ð¡Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº: Hreflang</h2>
        <div>
            <button id="add-row" class="btn btn-info text-white me-2">âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ</button>
            <button id="save-table" class="btn btn-success">ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
        </div>
    </div>
    
    <div id="status-msg" class="alert d-none"></div>
    <div id="hreflang-table"></div>
</div>
{% endblock %}

{% block javascripts %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const tableData = {{ table_json|raw }};

    var table = new Tabulator("#hreflang-table", {
        data: tableData,
        layout: "fitDataFill",
        height: "80vh",
        movableColumns: true,

        // ÐŸÐ¾Ð´ÑÐ²ÐµÑ‚ÐºÐ° Ð½Ð¾Ð²Ñ‹Ñ… ÑÑ‚Ñ€Ð¾Ðº
        rowFormatter: function(row) {
            if(!row.getData().id) {
                row.getElement().classList.add("row-new");
            }
        },
        
        columns: [
            {title:"ID", field:"id", width:70, frozen:true},
            
            // ÐšÐ¾Ð´ ÑÐ·Ñ‹ÐºÐ°
            {
                title:"ÐšÐ¾Ð´ (Code)", 
                field:"code", 
                editor:"input", 
                width:300,
                headerFilter:"input"
            },

            // Ð’ÐºÐ»/Ð’Ñ‹ÐºÐ»
            {
                title:"Ð’ÐºÐ»", 
                field:"is_active", 
                editor:true, 
                formatter:"tickCross", 
                hozAlign:"center", 
                width:100,
                editorParams:{
                    tristate:false,
                    indeterminateValue:null
                }
            },

            // Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ
            {title:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ", formatter:"buttonCross", width:100, align:"center", headerSort:false, cellClick:function(e, cell){
                if(confirm("Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ ÑÐ·Ñ‹Ðº?")) {
                    let id = cell.getRow().getData().id;
                    if(id) {
                         fetch('{{ path('api_hreflang_delete') }}', {
                            method: 'POST',
                            body: JSON.stringify({id: id})
                        }).then(() => cell.getRow().delete());
                    } else {
                        cell.getRow().delete();
                    }
                }
            }}
        ],
    });

    // ÐšÐ½Ð¾Ð¿ÐºÐ¸
    document.getElementById("add-row").addEventListener("click", function(){
        
        // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
        const newRowData = {
            code: "", 
            is_active: true
        };

        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð¸ ÑÐºÑ€Ð¾Ð»Ð»Ð¸Ð¼ Ðº Ð½ÐµÐ¹
        table.addRow(newRowData).then(function(row){
            // 1. ÐŸÐ»Ð°Ð²Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¾Ð»Ð»
            table.scrollToRow(row, "top", true);
            
            // 2. Ð¤Ð¾ÐºÑƒÑ Ð² Ð¿ÐµÑ€Ð²ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ 
            row.getCells()[1].edit(); 
        });
    });

    document.getElementById("save-table").addEventListener("click", function(){
        const btn = this;
        const msg = document.getElementById("status-msg");
        btn.disabled = true;
        btn.innerText = "Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ...";

        fetch('{{ path('api_hreflang_save') }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(table.getData())
        })
        .then(res => res.json())
        .then(res => {
            msg.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-danger';
            msg.innerText = res.message;
            msg.classList.remove('d-none');
            setTimeout(() => msg.classList.add('d-none'), 3000);
            
            if(res.status === 'success') {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            console.error(err);
            msg.className = 'alert alert-danger';
            msg.innerText = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
            msg.classList.remove('d-none');
        })
        .finally(() => btn.disabled = false);
    });
});
</script>
{% endblock %}

{# {% extends 'dashboard/layout.html.twig' %}

{% block title %}Ð¡Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº: Hreflang{% endblock %}

{% block body %}
<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>ðŸ“š Ð¡Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸Ðº: Hreflang</h2>
        <div>
            <button id="add-row" class="btn btn-info text-white me-2">âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ</button>
            <button id="save-table" class="btn btn-success">ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ</button>
        </div>
    </div>
    
    <div id="status-msg" class="alert d-none"></div>
    <div id="hreflang-table"></div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const tableData = {{ table_json|raw }};

    var table = new Tabulator("#hreflang-table", {
        data: tableData,
        layout: "fitDataFill",
        height: "80vh",
        movableColumns: true,

        rowFormatter: function(row) {
            // Ð•ÑÐ»Ð¸ Ñƒ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð½ÐµÑ‚ ID (Ð¾Ð½Ð° ÐµÑ‰Ðµ Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð² Ð‘Ð”), Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»Ð°ÑÑ
            if(!row.getData().id) {
                row.getElement().classList.add("row-new");
            }
        },
        
        columns: [
            {title:"ID", field:"id", width:70, frozen:true},
            
            // ÐšÐ¾Ð´ ÑÐ·Ñ‹ÐºÐ° (ru-RU, en-US Ð¸ Ñ‚.Ð´.)
            {
                title:"ÐšÐ¾Ð´ (Code)", 
                field:"code", 
                editor:"input", 
                width:300,
                headerFilter:"input" // Ð£Ð´Ð¾Ð±Ð½Ð¾ Ð¸ÑÐºÐ°Ñ‚ÑŒ, ÐµÑÐ»Ð¸ ÑÐ·Ñ‹ÐºÐ¾Ð² Ð¼Ð½Ð¾Ð³Ð¾
            },

            // Ð’ÐºÐ»/Ð’Ñ‹ÐºÐ»
            {
                title:"Ð’ÐºÐ»", 
                field:"is_active", 
                editor:true, 
                formatter:"tickCross", 
                hozAlign:"center", 
                width:100,
                editorParams:{
                    tristate:false,
                    indeterminateValue:null
                }
            },

            // Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ
            {title:"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ", formatter:"buttonCross", width:100, align:"center", headerSort:false, cellClick:function(e, cell){
                if(confirm("Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ ÑÐ·Ñ‹Ðº?")) {
                    let id = cell.getRow().getData().id;
                    if(id) {
                         fetch('{{ path('api_hreflang_delete') }}', {
                            method: 'POST',
                            body: JSON.stringify({id: id})
                        }).then(() => cell.getRow().delete());
                    } else {
                        cell.getRow().delete();
                    }
                }
            }}
        ],
    });

    // ÐšÐ½Ð¾Ð¿ÐºÐ¸
    document.getElementById("add-row").addEventListener("click", function(){
        table.addRow({code: "", is_active: true});

        table.addRow(defaultData).then(function(row){
            // 1. ÐŸÐ»Ð°Ð²Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¾Ð»Ð» Ðº Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐµ 
            table.scrollToRow(row, "top", true);
            
            // 2. Ð¤Ð¾ÐºÑƒÑ Ð² Ð¿ÐµÑ€Ð²ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ Ð´Ð»Ñ Ð²Ð²Ð¾Ð´Ð°
             row.getCells()[0].edit(); 
        });
    });

    document.getElementById("save-table").addEventListener("click", function(){
        const btn = this;
        const msg = document.getElementById("status-msg");
        btn.disabled = true;
        btn.innerText = "Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ...";

        fetch('{{ path('api_hreflang_save') }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(table.getData())
        })
        .then(res => res.json())
        .then(res => {
            msg.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-danger';
            msg.innerText = res.message;
            msg.classList.remove('d-none');
            setTimeout(() => msg.classList.add('d-none'), 3000);
            
            if(res.status === 'success') {
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(err => {
            console.error(err);
            msg.className = 'alert alert-danger';
            msg.innerText = 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ';
            msg.classList.remove('d-none');
        })
        .finally(() => btn.disabled = false);
    });
});
</script>
{% endblock %} #}