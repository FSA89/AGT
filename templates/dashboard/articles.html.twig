{% extends 'dashboard/layout.html.twig' %}

{% block title %}–ì–æ—Ç–æ–≤—ã–µ –¢–µ–∫—Å—Ç—ã (Articles){% endblock %}

{% block body %}
<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üìÑ –ì–æ—Ç–æ–≤—ã–µ –¢–µ–∫—Å—Ç—ã (Articles)</h2>
        <div>
            <button id="add-row" class="btn btn-info text-white me-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button id="save-table" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="status-msg" class="alert d-none"></div>
    <div id="articles-table"></div>
</div>
{% endblock %}

{% block javascripts %}
<style>
    /* 1. –°—Ç–∏–ª—å –¥–ª—è –°–í–ï–†–ù–£–¢–û–ì–û –≤–∏–¥–∞ */
    .compact-view {
        max-height: 40px;       
        overflow: hidden;       
        text-overflow: ellipsis;
        white-space: nowrap;    
        font-family: monospace; /* –®—Ä–∏—Ñ—Ç –∫–∞–∫ –≤ –∫–æ–¥–µ */
        color: #555;
        font-size: 12px;
        cursor: pointer;
        padding-top: 4px;
    }
    
    /* –ò–∫–æ–Ω–∫–∞ "–∫–æ–¥" –ø–µ—Ä–µ–¥ —Ç–µ–∫—Å—Ç–æ–º */
    .compact-view::before {
        content: "\f1c9"; /* FontAwesome icon */
        font-family: "Font Awesome 6 Free"; 
        font-weight: 900;
        margin-right: 5px;
        color: #0d6efd;
    }

    /* 2. –°—Ç–∏–ª—å –¥–ª—è –†–ï–î–ê–ö–¢–û–†–ê (–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –ø—Ä–∏ –∫–ª–∏–∫–µ) */
    .tabulator-cell textarea {
        min-height: 300px !important; 
        min-width: 400px !important;  
        font-family: monospace;
        font-size: 13px;
        line-height: 1.4;
        background-color: #fff !important;
        border: 2px solid #0d6efd !important;
        padding: 10px;
        z-index: 1000; /* –ü–æ–≤–µ—Ä—Ö —Ç–∞–±–ª–∏—Ü—ã */
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const tableData = {{ articles_json|raw }};
    const rawTasks = {{ dict_tasks|raw }};

    // –•–µ–ª–ø–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
    function toOptions(dict) {
        let opts = Object.keys(dict).map(key => ({
            label: dict[key],
            value: parseInt(key)
        }));
        opts.unshift({label: "", value: null});
        return opts;
    }
    const optionsTasks = toOptions(rawTasks);

    // –°—Ç–∞—Ç—É—Å—ã
    const dictStatus = {
        "ready": "–ì–æ—Ç–æ–≤–æ",
        "publish": "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å",
        "error": "–û—à–∏–±–∫–∞"
    };
    const optionsStatus = Object.keys(dictStatus).map(k => ({label: dictStatus[k], value: k}));

    // --- –§–û–†–ú–ê–¢–¢–ï–† –î–õ–Ø –°–ñ–ê–¢–ò–Ø –¢–ï–ö–°–¢–ê ---
    const compactFormatter = function(cell) {
        let val = cell.getValue();
        if(!val) return "";
        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML —Ç–µ–≥–∏, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –≤–µ—Ä—Å—Ç–∫—É —Ç–∞–±–ª–∏—Ü—ã
        let text = val.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        
        return `<div class="compact-view" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">${text}</div>`;
    };

    var table = new Tabulator("#articles-table", {
        data: tableData,
        layout: "fitDataFill",
        height: "80vh",
        movableColumns: true,
        pagination: "local",
        paginationSize: 20,

         // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫
        rowFormatter: function(row) {
            if(!row.getData().id) {
                row.getElement().classList.add("row-new");
            }
        },
        
        columns: [
            {title:"ID", field:"id", width:70, frozen:true},
            
            // –ù–æ–º–µ—Ä (42(1))
            {title:"‚Ññ", field:"task_custom_id", editor:"input", width:80, frozen:true},

            // –°–≤—è–∑—å —Å –ó–∞–¥–∞—á–µ–π (—Å –§–∏–ª—å—Ç—Ä–æ–º)
            {
                title: "–ó–∞–¥–∞—á–∞ (Task)", 
                field: "task_id", 
                width: 150,
                headerFilter: "input",
                editor: "list", 
                editorParams: {
                    values: optionsTasks,
                    autocomplete: true,
                    clearable: true,
                    listOnEmpty: true
                }, 
                formatter: "lookup", 
                formatterParams: rawTasks
            },

            // –î–æ–º–µ–Ω (—Å –§–∏–ª—å—Ç—Ä–æ–º)
            {
                title:"URL –î–æ–º–µ–Ω–∞", 
                field:"domain_url", 
                editor:"input", 
                width:200,
                headerFilter: "input"
            },

            // Query (—Å –§–∏–ª—å—Ç—Ä–æ–º, Read Only –∏–∑ –∑–∞–¥–∞—á–∏)
            {
                title:"Query (–ó–∞–ø—Ä–æ—Å)", 
                field:"task_query", 
                width:200,
                headerFilter:"input" 
            },

          
            
            // Title
            {
                title:"Title", 
                field:"title", 
                width:250,
                formatter: compactFormatter, 
                editor:"textarea"            
            },
            
            // Description
            {
                title:"Description", 
                field:"description", 
                width:250,
                formatter: compactFormatter,
                editor:"textarea"
            },

            // HTML –ö–æ–Ω—Ç–µ–Ω—Ç
            {
                title:"HTML –ö–æ–Ω—Ç–µ–Ω—Ç", 
                field:"content", 
                width: 400,
                formatter: compactFormatter, 
                editor:"textarea"
            },

            // –û—Ü–µ–Ω–∫–∞
            {title:"–û—Ü–µ–Ω–∫–∞", field:"rating", editor:"number", width:150},

            // –°—Ç–∞—Ç—É—Å
            {
                title: "–°—Ç–∞—Ç—É—Å", 
                field: "status", 
                width: 120,
                editor: "list", 
                editorParams: { values: optionsStatus, clearable: false },
                formatter: function(cell){
                    const val = cell.getValue();
                    const label = dictStatus[val] || val;
                    let color = val === 'ready' ? 'green' : (val === 'error' ? 'red' : 'blue');
                    return `<span style="color:${color}; font-weight:bold;">${label}</span>`;
                }
            },

              // –°—Ö–µ–º–∞ –ù–µ–π—Ä–æ—Å–µ—Ç–∏ (Snapshot)
            {
                title:"–°—Ö–µ–º–∞ (Snapshot)", 
                field:"scheme_neuro_snapshot", 
                width:250,
                formatter: compactFormatter
                //editor: "textarea"
            },
            
            // –£–¥–∞–ª–µ–Ω–∏–µ
            {formatter:"buttonCross", width:50, align:"center", headerSort:false, cellClick:function(e, cell){
                if(confirm("–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é?")) {
                    let id = cell.getRow().getData().id;
                    if(id) {
                         fetch('{{ path('api_articles_delete') }}', {
                            method: 'POST',
                            body: JSON.stringify({id: id})
                        }).then(() => cell.getRow().delete());
                    } else {
                        cell.getRow().delete();
                    }
                }
            }}
        ],
    });

    // --- –ö–Ω–æ–ø–∫–∏ ---
    document.getElementById("add-row").addEventListener("click", function(){

          // –î–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
        const newRowData = {
           status: 'ready', 
           rating: 0
        };

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏ —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–µ–π
        table.addRow(newRowData).then(function(row){
            // 1. –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª
            table.scrollToRow(row, "top", true);
            
            // 2. –§–æ–∫—É—Å –≤ –ø–µ—Ä–≤—É—é —è—á–µ–π–∫—É 
            row.getCells()[1].edit(); 
        });
    });

    document.getElementById("save-table").addEventListener("click", function(){
        const btn = this;
        const msg = document.getElementById("status-msg");
        btn.disabled = true;
        btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

        fetch('{{ path('api_articles_save') }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(table.getData())
        })
        .then(res => res.json())
        .then(res => {
            msg.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-danger';
            msg.innerText = res.message;
            msg.classList.remove('d-none');
            setTimeout(() => msg.classList.add('d-none'), 3000);
            if(res.status === 'success') setTimeout(() => location.reload(), 1000);
        })
        .catch(err => {
            console.error(err);
            msg.className = 'alert alert-danger';
            msg.innerText = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            msg.classList.remove('d-none');
        })
        .finally(() => btn.disabled = false);
    });
});
</script>
{% endblock %}