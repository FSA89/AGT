{% extends 'dashboard/layout.html.twig' %}

{% block title %}–†–∞–±–æ—á–∏–µ –ó–∞–¥–∞—á–∏ (Tasks){% endblock %}

{% block body %}
<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ó–∞–¥–∞—á–∞–º–∏ (Tasks)</h2>
        <div>
            {# –°–ü–ò–ù–ù–ï–† #}
            <span id="parser-loader" class="d-none me-2 text-primary fw-bold">
                <i class="fas fa-spinner fa-spin"></i> –ü–∞—Ä—Å–∏–Ω–≥...
            </span>

            <button id="btn-parser" class="btn btn-warning text-dark me-2" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á —Å URL">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ü–∞—Ä—Å–µ—Ä</button>
            
            <button id="add-row" class="btn btn-info text-white me-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
            <button id="save-table" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </div>
    
    <div id="status-msg" class="alert d-none"></div>

    <div id="tasks-table"></div>
</div>
{% endblock %}

{% block javascripts %}
<style>
    .compact-view {
        max-height: 40px;       
        overflow: hidden;       
        text-overflow: ellipsis;
        white-space: nowrap;    
        font-family: monospace; 
        color: #555;
        font-size: 12px;
        cursor: pointer;
        padding-top: 4px;
    }
    .compact-view::before {
        content: "\f0c9"; 
        font-family: "Font Awesome 6 Free"; 
        font-weight: 900;
        margin-right: 5px;
        color: #0d6efd;
    }
    .tabulator-cell textarea {
        min-height: 300px !important; 
        min-width: 400px !important;  
        font-family: monospace;
        font-size: 13px;
        line-height: 1.4;
        background-color: #fff !important;
        border: 2px solid #0d6efd !important;
        padding: 10px;
        z-index: 1000; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .row-new {
        border: 2px solid #0dcaf0 !important; 
        background-color: #f2fcff !important; 
        box-shadow: inset 0 0 5px rgba(13, 202, 240, 0.2); 
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const tableData = {{ tasks_json|raw }};
    const rawPageTypes = {{ dict_page_types|raw }};
    const rawHreflangs = {{ dict_hreflangs|raw }};
    const rawSchemes   = {{ dict_schemes|raw }};
    const statusUrlPattern = "{{ path('api_task_get_status', {'id': 999999}) }}";

    function toLookup(list) {
        let map = {};
        list.forEach(item => map[item.id] = item.name);
        return map;
    }
    function toOptionsActive(list) {
        let opts = list.filter(item => item.active).map(item => ({label: item.name, value: item.id}));
        opts.unshift({label: "", value: null}); 
        return opts;
    }

    const lookupPageTypes = toLookup(rawPageTypes);
    const optionsPageTypes = toOptionsActive(rawPageTypes);
    const lookupHreflangs = toLookup(rawHreflangs);
    const optionsHreflangs = toOptionsActive(rawHreflangs);
    const lookupSchemes = toLookup(rawSchemes);
    const optionsSchemes = toOptionsActive(rawSchemes);

    const dictStatus = { "generate": "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å", "processing": "–í —Ä–∞–±–æ—Ç–µ", "done": "–ì–æ—Ç–æ–≤–æ", "error": "–û—à–∏–±–∫–∞" };
    const optionsStatus = Object.keys(dictStatus).map(k => ({label: dictStatus[k], value: k}));

    // --- –ü–û–õ–õ–ò–ù–ì ---
    const activePolls = {}; 
    const parserLoader = document.getElementById('parser-loader');

    function updateLoaderVisibility() {
        if (Object.keys(activePolls).length > 0) {
            parserLoader.classList.remove('d-none');
        } else {
            parserLoader.classList.add('d-none');
        }
    }

    function startPolling(row) {
        let id = row.getData().id;
        if (!id || activePolls[id]) return; 

        activePolls[id] = true;
        updateLoaderVisibility();

        let url = statusUrlPattern.replace('999999', id);

        let interval = setInterval(() => {
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'deleted') {
                        clearInterval(interval); delete activePolls[id]; updateLoaderVisibility(); return;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
                    row.update({
                        status: data.status, // –ï—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è (–Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                        competitor_structures: data.competitor_structures
                    });

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏—à–µ–ª –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    let struct = data.competitor_structures || "";
                    // –ï—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–æ–ª—å—à–µ –Ω–µ "–ø—É—Å—Ç–∞—è" –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–æ "Parsing..."
                    // (–º—ã —Å–∞–º–∏ –µ–≥–æ —Ç—É–¥–∞ –ø–∏—à–µ–º –Ω–∏–∂–µ, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç)
                    if (struct.length > 5 && !struct.includes('Parsing...')) {
                        clearInterval(interval); 
                        delete activePolls[id]; 
                        updateLoaderVisibility();

                        row.getElement().style.transition = "background-color 0.5s";
                        row.getElement().style.backgroundColor = "#d1e7dd";
                        setTimeout(() => row.getElement().style.backgroundColor = "", 1000);
                    }
                })
                .catch(err => { 
                    console.error("Poll error:", err); 
                    clearInterval(interval); delete activePolls[id]; updateLoaderVisibility();
                });
        }, 3000);
    }

    // --- –ó–ê–ü–£–°–ö –ü–ê–†–°–ï–†–ê ---
    function runParser(cellOrRow, isBulk = false) {
        let updates = [];
        let rowsToPoll = [];

        if (isBulk) {
            const rows = table.getRows();
            rows.forEach(row => {
                let data = row.getData();
                // URL –µ—Å—Ç—å, –°—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–µ—Ç, ID –µ—Å—Ç—å
                if (data.competitor_urls && !data.competitor_structures && data.id) {
                    let rowData = row.getData();
                    rowData['_command'] = 'parse_structure'; // –°–ü–ï–¶. –ü–û–õ–ï
                    
                    // –í–∏–∑—É–∞–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º "Parsing..." –≤ –∫–æ–ª–æ–Ω–∫—É —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                    row.update({competitor_structures: "‚è≥ Parsing..."});
                    
                    updates.push(rowData);
                    rowsToPoll.push(row);
                }
            });
        } else {
            let row = cellOrRow.getRow();
            let rowData = row.getData();
            rowData['_command'] = 'parse_structure'; // –°–ü–ï–¶. –ü–û–õ–ï
            
            row.update({competitor_structures: "‚è≥ Parsing..."});
            
            updates.push(rowData);
            rowsToPoll.push(row);
        }

        if (updates.length === 0) {
            if (isBulk) alert("–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞.");
            return;
        }

        document.body.style.cursor = 'wait';
        fetch('{{ path('api_tasks_save') }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(updates)
        })
        .then(res => res.json())
        .then(res => {
            if(res.status === 'success') {
                rowsToPoll.forEach(r => startPolling(r));
            } else {
                alert('–û—à–∏–±–∫–∞: ' + res.message);
            }
        })
        .catch(err => { console.error(err); alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); })
        .finally(() => { document.body.style.cursor = 'default'; });
    }


    // --- –¢–ê–ë–õ–ò–¶–ê ---
    const compactFormatter = function(cell) {
        let val = cell.getValue();
        if(!val) return "";
        let text = val.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return `<div class="compact-view" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É">${text}</div>`;
    };

    const statusFormatter = function(cell){
        const val = cell.getValue();
        const label = dictStatus[val] || val;
        let color = 'black';
        if(val === 'done') color = 'green';
        if(val === 'processing') color = 'orange';
        if(val === 'error') color = 'red';
        return `<span style="color:${color}; font-weight:bold;">${label}</span>`;
    };

    const structureMenu = [
        {
            label: "üöÄ <b>–°–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É</b>", 
            action: function(e, cell){ 
                runParser(cell, false); 
            }
        },
        {separator:true},
        { label: "‚ùå –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ", action: function(e, cell){ cell.setValue(""); } }
    ];

    var table = new Tabulator("#tasks-table", {
        data: tableData,
        layout: "fitDataFill", 
        height: "85vh",        
        movableColumns: true,
        pagination: "local",
        paginationSize: 50,
        
        rowFormatter: function(row) {
            if(!row.getData().id) row.getElement().classList.add("row-new");
        },

        dataLoaded: function(data) {
            data.forEach(row => {
                // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–ª–∏–Ω–≥, –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ "–≤–∏—Å–∏—Ç"
                if (row.competitor_structures && row.competitor_structures.includes('Parsing')) {
                    let tableRow = table.getRow(row.id);
                    if(tableRow) startPolling(tableRow);
                }
            });
        },
        
        columns: [
            {title:"ID", field:"id", width:70, headerFilter:"input", frozen:true},
            {title:"–ì–ª–∞–≤–Ω—ã–π –∫–ª—é—á", field:"main_keyword", editor:"input", headerFilter:"input", width:200, frozen:true},
            {
                title: "–¢–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü—ã", field: "page_type_id", width: 150,
                editor: "list", editorParams: { values: optionsPageTypes, autocomplete: false, clearable: true }, 
                formatter: "lookup", formatterParams: lookupPageTypes 
            },
            {title:"–ö–ª—é—á–∏", field:"keywords", editor:"textarea", formatter:"textarea", width:250},
            {title:"URL –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤", field:"competitor_urls", editor:"textarea", width:250},
            
            // –°–¢–†–£–ö–¢–£–†–ê
            {
                title: "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤", field: "competitor_structures", width: 300,
                formatter: compactFormatter, editor: "textarea", clickMenu: structureMenu
            },

            {title:"–ö–æ–ª-–≤–æ", field:"count", editor:"number", width:90},
            {title:"–ì–æ—Ç–æ–≤–æ", field:"count_done", width:90},
            {
                title: "–°—Ç–∞—Ç—É—Å", field: "status", width: 130,
                editor: "list", editorParams: { values: optionsStatus, clearable: false }, formatter: statusFormatter
            },
            {title:"Query ID", field:"query", editor:"input", width:150},
            {
                title: "Lang", field: "hreflang_id", width: 100,
                editor: "list", editorParams: { values: optionsHreflangs, autocomplete: true, listOnEmpty: true, clearable: true }, 
                formatter: "lookup", formatterParams: lookupHreflangs
            },
            {
                title: "–°—Ö–µ–º–∞ –ù–µ–π—Ä–æ", field: "scheme_neuro_id", width: 250,
                editor: "list", editorParams: { values: optionsSchemes, autocomplete: false, clearable: true }, 
                formatter: "lookup", formatterParams: lookupSchemes
            },
            {formatter:"buttonCross", width:50, align:"center", headerSort:false, frozen:false, cellClick:function(e, cell){
                if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?")) {
                    let id = cell.getRow().getData().id;
                    if(id) {
                         fetch('{{ path('api_tasks_delete') }}', {
                            method: 'POST',
                            body: JSON.stringify({id: id})
                        }).then(() => cell.getRow().delete());
                    } else {
                        cell.getRow().delete();
                    }
                }
            }}
        ],
    });

    // --- –ö–ù–û–ü–ö–ò ---
    document.getElementById("add-row").addEventListener("click", function(){
        const newRowData = { status: 'generate', count: 1 };
        table.addRow(newRowData).then(function(row){
            table.scrollToRow(row, "top", true);
            row.getElement().classList.add("row-new");
        });
    });

    document.getElementById("btn-parser").addEventListener("click", function(){
        runParser(null, true);
    });

    document.getElementById("save-table").addEventListener("click", function(){
        const btn = this;
        const msg = document.getElementById("status-msg");
        btn.disabled = true;
        btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";

        fetch('{{ path('api_tasks_save') }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(table.getData())
        })
        .then(res => res.json())
        .then(res => {
            msg.className = res.status === 'success' ? 'alert alert-success' : 'alert alert-danger';
            msg.innerText = res.message;
            msg.classList.remove('d-none');
            setTimeout(() => msg.classList.add('d-none'), 3000);
            if(res.status === 'success') setTimeout(() => location.reload(), 1000);
        })
        .catch(err => {
            console.error(err);
            msg.className = 'alert alert-danger';
            msg.innerText = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            msg.classList.remove('d-none');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
        });
    });
});
</script>
{% endblock %}